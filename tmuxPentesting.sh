#!/bin/bash

#args
ip=$1
machine=$2

#Vars
TIMEWAIT=0.5
SESSION="HTB"
#Session exists?
SESSIONEXISTS=$(tmux list-sessions | grep $SESSION)
#WORKDIR
WORKDIR="/home/buffer/Documents/HTB/${machine}"

# create if not exists
if [ "$SESSIONEXISTS" = "" ]
then
    # Start HTB session - detach it and wait for.
    tmux new-session -d -s $SESSION
    # First default window rename
    tmux rename-window "Enumeration" 
    # Settarget and clear on default window
    tmux send-keys -t $SESSION:1 "settarget ${ip} ${machine}" C-m && sleep $TIMEWAIT
    # create every window
    tmux new-window -t $SESSION:2 -n 'Exploit'
    tmux new-window -t $SESSION:3 -n 'Misc'
    tmux new-window -t $SESSION:4 -n 'Extra'
    # send cmd to all windows
    #set target IP
    tmux list-windows -t $SESSION|cut -d: -f1|xargs -I{} tmux send-keys -t $SESSION:{} "IP=${ip}" C-m && sleep $TIMEWAIT
    # create work dir
    tmux send-keys -t $SESSION:1 "mkdir ${WORKDIR} 2>/dev/null" C-m && sleep $TIMEWAIT
    # enter all windows to workdir
    tmux list-windows -t $SESSION|cut -d: -f1|xargs -I{} tmux send-keys -t $SESSION:{} "cd ${WORKDIR}" C-m && sleep $TIMEWAIT
fi
#Clean out
tmux list-windows -t $SESSION|cut -d: -f1|xargs -I{} tmux send-keys -t $SESSION:{} "clear" C-m && sleep $TIMEWAIT
# Attach to session and set first window
tmux attach-session -t $SESSION:1 && sleep $TIMEWAIT